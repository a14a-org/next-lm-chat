name: Dependabot auto-merge
on: pull_request_target

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Enable auto-merge for patch/minor updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Slack notification for minor update
        if: steps.metadata.outputs.update-type == 'version-update:semver-minor'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "üì¶ *Minor dependency update* in `${{ github.repository }}`",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üì¶ *Minor dependency update*\n*Repo:* `${{ github.repository }}`\n*Dependency:* `${{ steps.metadata.outputs.dependency-names }}`\n*Update:* `${{ steps.metadata.outputs.previous-version }}` ‚Üí `${{ steps.metadata.outputs.new-version }}`\n*PR:* <${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }}>\n\n‚úÖ Auto-merge enabled"
                  }
                }
              ]
            }

      - name: Slack notification for major update
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "üö® Major dependency update needs review in ${{ github.repository }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<!channel> üö® *Major dependency update - manual review required*\n*Repo:* `${{ github.repository }}`\n*Dependency:* `${{ steps.metadata.outputs.dependency-names }}`\n*Update:* `${{ steps.metadata.outputs.previous-version }}` ‚Üí `${{ steps.metadata.outputs.new-version }}`\n*PR:* <${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }}>\n\n‚ö†Ô∏è This is a major version bump and requires manual review and merge."
                  }
                }
              ]
            }

